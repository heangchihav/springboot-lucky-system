apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-backup-script
  namespace: demo
data:
  backup.sh: |
    #!/bin/bash
    set -euo pipefail
    
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    BACKUP_DIR="/backups"
    POSTGRES_HOST="postgres"
    RETENTION_DAYS="${BACKUP_RETENTION_DAYS:-30}"
    
    DATABASES=(
        "user_service_db"
        "call_service_db"
        "delivery_service_db"
        "marketing_service_db"
    )
    
    echo "[${TIMESTAMP}] Starting automated data backup..."
    
    # Backup each database with complete data
    for db in "${DATABASES[@]}"; do
        BACKUP_FILE="${BACKUP_DIR}/${db}_data_${TIMESTAMP}.sql.gz"
        echo "[${TIMESTAMP}] Backing up ${db} with data..."
        
        # Use pg_dump with explicit data inclusion
        if PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump -h "${POSTGRES_HOST}" -U "${POSTGRES_USER}" --verbose --column-inserts "${db}" 2>/dev/null | gzip > "${BACKUP_FILE}"; then
            echo "[${TIMESTAMP}] ✓ ${db} data backup successful"
        else
            echo "[${TIMESTAMP}] ✗ ${db} data backup failed"
        fi
    done
    
    # Complete data backup
    ALL_DATA_BACKUP_FILE="${BACKUP_DIR}/all_databases_data_${TIMESTAMP}.sql.gz"
    echo "[${TIMESTAMP}] Creating complete data backup..."
    
    if PGPASSWORD="${POSTGRES_PASSWORD}" pg_dumpall -h "${POSTGRES_HOST}" -U "${POSTGRES_USER}" --verbose 2>/dev/null | gzip > "${ALL_DATA_BACKUP_FILE}"; then
        echo "[${TIMESTAMP}] ✓ Complete data backup successful"
    else
        echo "[${TIMESTAMP}] ✗ Complete data backup failed"
    fi
    
    # Cleanup old data backups
    echo "[${TIMESTAMP}] Cleaning up data backups older than ${RETENTION_DAYS} days..."
    find "${BACKUP_DIR}" -name "*_data_*.sql.gz" -type f -mtime +${RETENTION_DAYS} -delete
    
    REMAINING=$(find "${BACKUP_DIR}" -name "*_data_*.sql.gz" -type f | wc -l)
    echo "[${TIMESTAMP}] Data backup completed. Total data backups: ${REMAINING}"

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-backup-pvc
  namespace: demo
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: demo
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: postgres-backup
        spec:
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: postgres:16
            command: ["/bin/bash", "/scripts/backup.sh"]
            env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
            - name: BACKUP_RETENTION_DAYS
              value: "30"
            volumeMounts:
            - name: backup-storage
              mountPath: /backups
            - name: backup-script
              mountPath: /scripts
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: postgres-backup-pvc
          - name: backup-script
            configMap:
              name: postgres-backup-script
              defaultMode: 0755
