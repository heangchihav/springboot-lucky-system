# Cloudflare Tunnel Configuration

## Overview

This directory contains the configuration for Cloudflare named tunnel setup.

## Files

- **`config.yml`** - Tunnel configuration with environment variable support
- **`demo-tunnel.json`** - Tunnel credentials (generated by `cloudflared tunnel create`)
- **`cert.pem`** - Origin certificate (generated by `cloudflared login`)

## Environment Variables

The configuration supports the following environment variables for flexibility:

| Variable | Default | Description |
|----------|---------|-------------|
| `CLOUDFLARE_TUNNEL_NAME` | `demo-tunnel` | Name of the tunnel |
| `CLOUDFLARE_DOMAIN` | `test.mooniris.com` | Domain to route through tunnel |
| `CLOUDFLARE_SERVICE` | `http://nginx:80` | Backend service URL |

## Changing Domain

### Option 1: Environment Variables (Recommended)

Update `.env` file:

```bash
CLOUDFLARE_DOMAIN=new-domain.com
```

Then restart the services:

```bash
docker compose restart cloudflared
```

### Option 2: Multiple Environments

Create separate `.env` files for each environment:

```bash
# .env.dev
CLOUDFLARE_DOMAIN=dev.mooniris.com

# .env.staging
CLOUDFLARE_DOMAIN=staging.mooniris.com

# .env.prod
CLOUDFLARE_DOMAIN=test.mooniris.com
```

Use with:

```bash
docker compose --env-file .env.prod up -d
```

### Option 3: Direct Configuration Edit

Edit `config.yml` directly (not recommended for production):

```yaml
ingress:
  - hostname: your-new-domain.com
    service: http://nginx:80
```

## DNS Configuration

After changing the domain, update DNS in Cloudflare Dashboard:

1. Go to **Cloudflare Dashboard** → Your domain
2. Navigate to **DNS** → **Records**
3. Add/Update CNAME record:
   - **Type**: CNAME
   - **Name**: subdomain (e.g., `test`)
   - **Target**: `b3eda752-5dad-4beb-a70f-44a4dcf2b9bc.cfargotunnel.com`
   - **Proxy**: Enabled (orange cloud)

## Creating New Tunnel

```bash
# 1. Login to Cloudflare
cloudflared tunnel login

# 2. Create tunnel
cloudflared tunnel create your-tunnel-name

# 3. Copy credentials
cp ~/.cloudflared/<tunnel-id>.json ./your-tunnel-name.json

# 4. Update .env
CLOUDFLARE_TUNNEL_NAME=your-tunnel-name
CLOUDFLARE_DOMAIN=your-domain.com

# 5. Route DNS
cloudflared tunnel route dns your-tunnel-name your-domain.com
```

## Kubernetes Deployment

For Kubernetes, update the ConfigMap in `k8s/cloudflared-env.yaml`:

```yaml
data:
  CLOUDFLARE_DOMAIN: "your-domain.com"
```

Then apply:

```bash
kubectl apply -k infra/k8s/
```

## Troubleshooting

### Tunnel not connecting

Check logs:
```bash
docker compose logs cloudflared --tail=50
```

Common issues:
- Missing credentials file
- Wrong tunnel name
- DNS not configured
- Certificate permissions

### Domain not accessible

1. Verify tunnel is connected (check logs)
2. Check DNS configuration in Cloudflare
3. Verify domain in `config.yml` matches DNS
4. Check nginx is healthy: `docker compose ps nginx`

## Best Practices

1. ✅ Use environment variables for domain configuration
2. ✅ Keep credentials files secure (not in git)
3. ✅ Use separate tunnels for different environments
4. ✅ Monitor tunnel status in Cloudflare dashboard
5. ✅ Document DNS changes in your infrastructure repo
6. ❌ Don't hardcode domains in configuration files
7. ❌ Don't commit `.json` or `.pem` files to git
